```bash
wavemae/                         # GitHub リポジトリのルート（プロジェクト全体のトップディレクトリ）
│
├─ src/                          # Python パッケージのソースコードを格納するルート
│  └─ wavemae/                   # 実際に import される Python パッケージ本体（`import wavemae`）
│     ├─ __init__.py             # パッケージ初期化処理。__version__ の読み込み、サブパッケージの公開を行う
│     ├─ _version.py             # バージョン番号を一元管理するモジュール（例: __version__ = "0.1.0"）
│     ├─ py.typed                # 型チェッカーに型情報を認識させるためのマーカー
│     │
│     ├─ preprocessing/          # 前処理アルゴリズム群（スペクトル正規化など）
│     │  ├─ __init__.py          # サブパッケージの公開設定（例: snv, SNVScaler を import 時に利用可能に）
│     │  └─ snv.py               # SNV (Standard Normal Variate) 実装。1Dスペクトルの代表的前処理
│     │
│     ├─ models/                 # WaveMAE とその関連モデル
│     │  ├─ __init__.py          # モデル関連の公開APIをまとめる（WaveMAE / 損失関数 / ヘッド）
│     │  ├─ wave_mae.py          # WaveMAE 本体。TransformerベースのMAE実装
│     │  ├─ heads.py             # 投影ヘッドや識別用の出力層（今は空だが将来拡張を想定）
│     │  └─ losses.py            # 損失関数群（例: masked_sse, masked_mse など）
│     │
│     ├─ training/               # 学習と評価に関するモジュール
│     │  ├─ __init__.py          # Trainer/Tester/Optimizer utils を公開
│     │  ├─ trainer.py           # 学習ループ。AMP, EMA, checkpoint, 学習履歴の記録などを実装
│     │  ├─ tester.py            # 評価ループ。再構成誤差（SSE/MSE）でモデルを評価
│     │  ├─ extracter.py         # 潜在表現を一括抽出するためのユーティリティ
│     │  ├─ callbacks.py         # EarlyStopping や EMA などの学習フック群
│     │  └─ samplers.py          # Cosine 類似度に基づく WeightedRandomSampler の実装
│     │
│     ├─ clustering/             # クラスタリング関連モジュール
│     │  ├─ __init__.py          # CosineKMeans / ops を公開
│     │  ├─ cosine_kmeans.py     # Cosine-KMeans アルゴリズム本体
│     │  └─ ops.py               # クラスタリング用の補助関数（例: l2_normalize_rows）
│     │
│     ├─ utils/                  # 汎用的なユーティリティ群
│     │  ├─ __init__.py          # 公開APIを整理
│     │  ├─ seed.py              # 乱数シード固定・CUDNNの再現性制御
│     │  └─ load.py              # 学習済み重みのロード。SHA256検証付きダウンロード等
│     │
│     └─ assets/                       # サンプル重み・チェックサムなど（パッケージに同梱）
│        ├─ wavemae_base_256.pt        # 事前学習済み重み
│        └─ wavemae_base_256.pt.sha256 # 上記重みの SHA256 チェックサム（整合性確認用）
│
├─ tests/                           # Pytestベースの自動テスト集約
│  ├─ conftest.py                   # 共通fixture（乱数シード、デバイス判定、tmpdir 等）
│  │
│  ├─ test_import.py                # 基本 import チェック（wavemae と各サブモジュール）
│  │
│  ├─ preprocessing/                # 前処理
│  │   └─ test_snv.py               # SNV: 行ごとの0平均・不偏1分散、dtype/device保持、逆変換
│  │
│  ├─ models/                       # モデル（WaveMAE・損失）
│  │   ├─ test_losses.py            # masked_sse/masked_mse の reduction と勾配
│  │   ├─ test_wave_mae_forward.py  # forward/encode/reconstruct の形状・勾配
│  │   └─ test_wave_mae_mask.py     # ブロックマスクの性質・極端ケース（0/全マスク）
│  │
│  ├─ training/                     # 学習・評価・最適化・サンプラ
│  │   ├─ test_callbacks.py         # EarlyStopping の開始/停止、EMA の適用挙動
│  │   ├─ test_extracter.py         # 潜在抽出のCPU実行・.pt/.npy保存・戻り型
│  │   ├─ test_optim.py             # 最適化グループ（decay/no_decay）とLRスケジューラ
│  │   ├─ test_samplers.py          # 参照ベクトル・コサイン重み・プロット保存分岐
│  │   ├─ test_tester.py            # 評価ループ実行・history追記・固定マスク指定
│  │   └─ test_trainer_smoke.py     # Trainer を極小構成で2epochスモーク・成果物生成
│  │
│  ├─ clustering/                   # クラスタリング
│  │   ├─ test_ops.py               # l2正規化/コサイン(不)類似度/エルボー曲線と描画
│  │   └─ test_cosine_kmeans.py     # CosineKMeans の fit/predict/inertia/保存・読込
│  │
│  └─ utils/                        # ユーティリティ
│      ├─ test_seed.py              # 乱数固定とCUDNN決定論フラグの切替
│      └─ test_load.py              # モデル構築・SHA256検証・重みロード（アセット有無でskip）
│                                   # - get_default_config() 値チェック
│                                   # - 同梱アセット (weights/.sha256) の存在確認
│                                   # - verify_sha256() 検証
│                                   # - load_weight_with_sha256() で厳密ロード
│                                   # - （assets 未同梱環境では一部 skip）　
│                                    
├─ .github/                         # GitHub Actions 設定用のディレクトリ
│   └─ workflows/                   # ワークフローファイル
│
├─ .gitignore                      # Git管理対象外にするファイル・ディレクトリの指定
├─ LICENSE                         # ライセンスファイル
├─ MANIFEST.in                     # sdist 配布物に含めるファイルの指定（README, LICENSE, assets など）
├─ NOTICE                          # ライセンスファイル （簡略版）
├─ pyproject.toml                  # PEP 621 準拠のビルド設定・依存関係・メタ情報
└─ README.md                       # プロジェクトの説明。PyPIやGitHubで表示されるトップドキュメント
```

---

## To do

* **README.md 充実**

  * プロジェクト概要、使用方法、API 例、研究背景を追記。
    👉 PyPI ページは README.md がそのまま表示されるので、最小限の「インストール」「import 確認」「簡単なコード例」を必ず入れる。
  * PyPI 向けに最小限のインストール方法・サンプルコードを入れる。
    👉 例：`pip install wavemae` → `import wavemae` → `wavemae.utils.load.load_default_pretrained()` の簡易例。
  * バッジ（PyPI version / Python versions / License）を追加。
    👉 GitHub Actions の CI ステータスバッジも入れると研究者／開発者に安心感を与える。

* **`src/wavemae/assets/` に事前学習済み重みを配置**

  * `wavemae_base_256.pt`
  * `wavemae_base_256.pt.sha256`（SHA256 チェックサムファイル）
  * → `load.py` のテストで skip していた箇所が有効になる。
    ⚠️ PyPI に含める場合はファイルサイズ制限（1 ファイルあたり \~60MB, 全体 \~100MB）を意識。大きすぎる場合は GitHub Release / HuggingFace Hub 等で配布する方法も検討。

* **test の skip 部分を修正**

  * アセットが揃ったら `test_assets_presence_and_hash` を有効化。
  * CI 上で `verify_sha256` が通ることを確認。
    👉 アセットが存在しない状態だと CI が落ちるので、**assets を含めたタイミングで skip を外す**。

* **Secrets 登録（GitHub → Settings → Secrets → Actions）**

  * `TEST_PYPI_API_TOKEN`（TestPyPI の project-scoped token）
  * `PYPI_API_TOKEN`（PyPI の project-scoped token）
    ⚠️ Token の scope は **Project\:Publish** に限定。Account token は使わない。

* **ローカル検証**

  * `python -m build` → `python -m twine check dist/*` で配布物を検査。
  * sdist/whl に `LICENSE` / `NOTICE` が含まれることを確認。
  * ローカルで

    ```powershell
    pip install dist\wavemae-0.1.0-py3-none-any.whl
    python -c "import wavemae; print(wavemae.__version__)"
    ```

    → import テスト（assets 抜きで確認済み）。
    ⚠️ PowerShell の場合 `pip install dist/*.whl` は展開されないので、**ファイル名をフル指定**する。

* **TestPyPI 検証（自動）**

  ```bash
  git tag v0.1.0-rc1
  git push origin v0.1.0-rc1
  ```

  👉 Actions の `release-testpypi.yml` が走り、TestPyPI に公開される。
  👉 `pip install -i https://test.pypi.org/simple/ wavemae` でインストール確認。

* **本番リリース（自動）**

  ```bash
  git tag v0.1.0
  git push origin v0.1.0
  ```

  👉 Actions の `release-pypi.yml` が走り、本番 PyPI に公開される。
  👉 公開後は通常の `pip install wavemae` で利用可能。